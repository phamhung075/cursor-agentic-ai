#!/usr/bin/env node

/**
 * ðŸš€ Agent AI Installer - Install Agent AI system into any project
 * 
 * This script copies the complete Agent AI system to another project directory
 */

const fs = require('fs').promises;
const path = require('path');
const readline = require('readline');
const { execSync } = require('child_process');

class AgentAIInstaller {
  constructor() {
    this.rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });
    
    this.sourceRoot = path.resolve(__dirname, '../../..');
    this.requiredFiles = [
      // Core agent files
      '.cursor/rules/agents/self-improvement/',
      '.cursor/rules/agents/utils/',
      '.cursor/rules/agents/_store/scripts/setup-env.js',
      '.cursor/rules/agents/_store/scripts/demo_agent.js',
      '.cursor/rules/agents/_store/scripts/self_improvement_agent_legacy.js',
      '.cursor/rules/agents/_store/templates/environment-template.env',
      '.cursor/rules/agents/_store/tests/',
      '.cursor/rules/agents/README.md',
      
      // Documentation
      '.cursor/rules/agents/_store/docs/'
    ];
    
    this.requiredDependencies = {
      "chokidar": "^3.5.3",
      "marked": "^5.1.1", 
      "gray-matter": "^4.0.3",
      "chalk": "^4.1.2",
      "@pinecone-database/pinecone": "^2.0.1",
      "openai": "^4.28.0"
    };
    
    this..cursor/rules/agentscripts = {
      "AAI:start": "node .cursor/rules/agents/self-improvement/index.js",
      "AAI:agent": "node .cursor/rules/agents/self-improvement/index.js",
      "AAI:analyze": "node .cursor/rules/agents/self-improvement/index.js",
      "AAI:improve": "node .cursor/rules/agents/self-improvement/index.js",
      "AAI:legacy": "node .cursor/rules/agents/_store/scripts/self_improvement_agent_legacy.js",
      "AAI:demo": "node .cursor/rules/agents/_store/scripts/demo_agent.js",
      "AAI:install-deps": "npm install",
      "AAI:test": "echo \"Tests to be implemented\" && exit 0",
      "AAI:test-agent": "node .cursor/rules/agents/_store/tests/test_new_agent.js",
      "AAI:test-system": "node .cursor/rules/agents/_store/tests/test_new_system.js",
      "AAI:test-integration": "node .cursor/rules/agents/_store/tests/test_autopilot_integration.js",
      "AAI:test-dependencies": "node .cursor/rules/agents/_store/tests/test_dependency_tracking.js",
      "AAI:migrate-files": "node .cursor/rules/agents/utils/migrate_to_store.js",
      "AAI:setup-env": "node .cursor/rules/agents/_store/scripts/setup-env.js",
      "AAI:test-startup": "node .cursor/rules/agents/self-improvement/index.js --test"
    };
  }

  showHelp() {
    console.log('ðŸš€ Agent AI Installer');
    console.log('=' .repeat(50));
    console.log('Install the complete Agent AI system into any project\n');
    
    console.log('ðŸ¤– AI Assistant Compatibility:');
    console.log('  âœ… Windsurf - Full compatibility');
    console.log('  âœ… Cursor - Full compatibility');
    console.log('  âœ… Cline - Full compatibility');
    console.log('  âœ… Any AI Assistant - Universal support');
    console.log('  ðŸ’¡ Runs independently alongside your chosen AI tool!\n');
    
    console.log('ðŸ“– Usage:');
    console.log('  node install-agent-ai.js [target-directory]');
    console.log('  node install-agent-ai.js --help\n');
    
    console.log('ðŸ“ Examples:');
    console.log('  node install-agent-ai.js                    # Install to current directory');
    console.log('  node install-agent-ai.js /path/to/project   # Install to specific directory');
    console.log('  node install-agent-ai.js --help             # Show this help\n');
    
    console.log('ðŸŽ¯ What gets installed:');
    console.log('  âœ… Complete Agent AI system (.cursor/rules/agents/ directory)');
    console.log('  âœ… All required dependencies in package.json');
    console.log('  âœ… AAI scripts for npm run commands');
    console.log('  âœ… Environment template (.env.example)');
    console.log('  âœ… Proper .gitignore entries');
    console.log('  âœ… Complete documentation');
    console.log('  âœ… File dependency tracking system');
    console.log('  âœ… Intelligent memory with Pinecone integration\n');
    
    console.log('ðŸš€ After installation:');
    console.log('  cd target-directory');
    console.log('  npm run AAI:agent          # Start the Agent AI');
    console.log('  npm run AAI:test-system    # Test installation');
    console.log('  npm run AAI:setup-env      # Setup environment\n');
    
    console.log('ðŸ’¡ The Agent AI works 100% locally without API keys!');
    console.log('ðŸ¤– Compatible with Windsurf, Cursor, Cline, and all AI assistants!');
    console.log('ðŸ“š Full documentation: .cursor/rules/agents/_store/docs/INSTALLATION_GUIDE.md');
  }

  async install() {
    // Check for help flag
    if (process.argv.includes('--help') || process.argv.includes('-h')) {
      this.showHelp();
      this.rl.close();
      return;
    }

    console.log('ðŸš€ Agent AI Installer');
    console.log('=' .repeat(50));
    
    try {
      // Get target directory
      const targetDir = await this.getTargetDirectory();
      
      // Validate target directory
      await this.validateTarget(targetDir);
      
      // Confirm installation
      const confirmed = await this.confirmInstallation(targetDir);
      if (!confirmed) {
        console.log('Installation cancelled.');
        return;
      }
      
      // Create backup if package.json exists
      await this.createBackup(targetDir);
      
      // Copy agent files
      console.log('\nðŸ“ Copying Agent AI files...');
      await this.copyAgentFiles(targetDir);
      
      // Setup directory structure
      console.log('ðŸ“‚ Setting up directory structure...');
      await this.setupDirectories(targetDir);
      
      // Update package.json
      console.log('ðŸ“ Updating package.json...');
      await this.updatePackageJson(targetDir);
      
      // Create environment template
      console.log('ðŸ”§ Setting up environment...');
      await this.setupEnvironment(targetDir);
      
      // Install dependencies
      console.log('ðŸ“¦ Installing dependencies...');
      await this.installDependencies(targetDir);
      
      // Create gitignore entries
      console.log('ðŸ›¡ï¸ Setting up .gitignore...');
      await this.setupGitignore(targetDir);
      
      // Success message
      this.showSuccessMessage(targetDir);
      
    } catch (error) {
      console.error('âŒ Installation failed:', error.message);
      console.error('Please check the error and try again.');
      console.log('\nðŸ’¡ Run with --help for usage information');
    }
    
    this.rl.close();
  }

  async getTargetDirectory() {
    const argDir = process.argv[2];
    if (argDir && !argDir.startsWith('--')) {
      return path.resolve(argDir);
    }
    
    const defaultTarget = process.cwd();
    const target = await this.ask(`ðŸ“ Target project directory (${defaultTarget}): `) || defaultTarget;
    return path.resolve(target);
  }

  async validateTarget(targetDir) {
    try {
      const stats = await fs.stat(targetDir);
      if (!stats.isDirectory()) {
        throw new Error('Target must be a directory');
      }
    } catch (error) {
      if (error.code === 'ENOENT') {
        const create = await this.ask('Directory does not exist. Create it? (y/n): ');
        if (create.toLowerCase() === 'y') {
          await fs.mkdir(targetDir, { recursive: true });
        } else {
          throw new Error('Target directory does not exist');
        }
      } else {
        throw error;
      }
    }
  }

  async confirmInstallation(targetDir) {
    console.log(`\nðŸŽ¯ Installing Agent AI to: ${targetDir}`);
    console.log('This will:');
    console.log('  âœ… Copy all Agent AI files');
    console.log('  âœ… Update package.json with AAI scripts');
    console.log('  âœ… Install required dependencies');
    console.log('  âœ… Setup environment configuration');
    console.log('  âœ… Create proper .gitignore entries');
    
    const confirm = await this.ask('\nProceed with installation? (y/n): ');
    return confirm.toLowerCase() === 'y';
  }

  async createBackup(targetDir) {
    const packageJsonPath = path.join(targetDir, 'package.json');
    try {
      await fs.access(packageJsonPath);
      const backupPath = path.join(targetDir, 'package.json.backup');
      await fs.copyFile(packageJsonPath, backupPath);
      console.log('ðŸ’¾ Created package.json backup');
    } catch {
      // No package.json exists, continue
    }
  }

  async copyAgentFiles(targetDir) {
    for (const filePattern of this.requiredFiles) {
      const sourcePath = path.join(this.sourceRoot, filePattern);
      const targetPath = path.join(targetDir, filePattern);
      
      try {
        await this.copyRecursive(sourcePath, targetPath);
        console.log(`  âœ… ${filePattern}`);
      } catch (error) {
        console.warn(`  âš ï¸ ${filePattern} - ${error.message}`);
      }
    }
  }

  async copyRecursive(src, dest) {
    const stats = await fs.stat(src);
    
    if (stats.isDirectory()) {
      await fs.mkdir(dest, { recursive: true });
      const files = await fs.readdir(src);
      
      for (const file of files) {
        const srcFile = path.join(src, file);
        const destFile = path.join(dest, file);
        await this.copyRecursive(srcFile, destFile);
      }
    } else {
      await fs.mkdir(path.dirname(dest), { recursive: true });
      await fs.copyFile(src, dest);
    }
  }

  async setupDirectories(targetDir) {
    const directories = [
      '.cursor/rules/agents/_store/projects',
      '.cursor/rules/agents/_store/memory/embeddings',
      '.cursor/rules/agents/_store/memory/contexts', 
      '.cursor/rules/agents/_store/memory/learning',
      '.cursor/rules/agents/_store/logs'
    ];
    
    for (const dir of directories) {
      await fs.mkdir(path.join(targetDir, dir), { recursive: true });
    }
  }

  async updatePackageJson(targetDir) {
    const packageJsonPath = path.join(targetDir, 'package.json');
    let packageJson = {};
    
    try {
      const content = await fs.readFile(packageJsonPath, 'utf8');
      packageJson = JSON.parse(content);
    } catch {
      // Create new package.json
      packageJson = {
        name: path.basename(targetDir),
        version: "1.0.0",
        description: "Project enhanced with Agent AI",
        main: "index.js"
      };
    }
    
    // Add dependencies
    packageJson.dependencies = {
      ...packageJson.dependencies,
      ...this.requiredDependencies
    };
    
    // Add scripts
    packageJson.scripts = {
      ...packageJson.scripts,
      ...this..cursor/rules/agentscripts
    };
    
    // Add keywords
    const agentKeywords = ["ai", "agent", "self-improvement", "automation"];
    packageJson.keywords = [
      ...(packageJson.keywords || []),
      ...agentKeywords.filter(k => !(packageJson.keywords || []).includes(k))
    ];
    
    await fs.writeFile(packageJsonPath, JSON.stringify(packageJson, null, 2));
  }

  async setupEnvironment(targetDir) {
    const envPath = path.join(targetDir, '.env.example');
    const envContent = `# ðŸ§  Agent AI - Environment Configuration
# Copy this to .env and fill in your API keys

# ==================================================
# ðŸŒ Pinecone Configuration (for Agent Memory)
# ==================================================
PINECONE_API_KEY=your_pinecone_api_key_here
PINECONE_INDEX_NAME=agent-ai-memory

# ==================================================
# ðŸ¤– OpenAI Configuration (for Embeddings)  
# ==================================================
OPENAI_API_KEY=your_openai_api_key_here

# ==================================================
# ðŸ“ Project Configuration
# ==================================================
PROJECT_NAME=my-project
AGENT_MEMORY_ENABLED=true
AGENT_FILESTORE_ENABLED=true

# ==================================================
# ðŸ”§ Optional Settings
# ==================================================
MEMORY_RETENTION_DAYS=90
MAX_LOCAL_MEMORIES=1000
DEBUG=false
LOG_LEVEL=info
`;
    
    await fs.writeFile(envPath, envContent);
  }

  async installDependencies(targetDir) {
    try {
      process.chdir(targetDir);
      execSync('npm install', { stdio: 'inherit' });
    } catch (error) {
      console.warn('âš ï¸ Failed to install dependencies automatically.');
      console.log('Please run "npm install" manually in the target directory.');
    }
  }

  async setupGitignore(targetDir) {
    const gitignorePath = path.join(targetDir, '.gitignore');
    const agentIgnoreRules = `
# Agent AI - Protect sensitive data
.cursor/rules/agents/_store/memory/
.cursor/rules/agents/_store/logs/
.cursor/rules/agents/_store/projects/*/

# Environment files
.env
.env.local
.env.*.local

# API Keys and secrets
*.key
*.pem
secrets.json

# Node modules (if not already present)
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
`;
    
    try {
      let gitignoreContent = '';
      try {
        gitignoreContent = await fs.readFile(gitignorePath, 'utf8');
      } catch {
        // .gitignore doesn't exist
      }
      
      if (!gitignoreContent.includes('.cursor/rules/agents/_store/memory/')) {
        await fs.writeFile(gitignorePath, gitignoreContent + agentIgnoreRules);
      }
    } catch (error) {
      console.warn('âš ï¸ Could not update .gitignore:', error.message);
    }
  }

  showSuccessMessage(targetDir) {
    console.log('\nðŸŽ‰ Agent AI Installation Complete!');
    console.log('=' .repeat(50));
    console.log(`ðŸ“ Installed to: ${targetDir}`);
    console.log('\nðŸš€ Next Steps:');
    console.log('1. Navigate to your project:');
    console.log(`   cd ${targetDir}`);
    console.log('\n2. Setup environment (optional):');
    console.log('   npm run AAI:setup-env');
    console.log('\n3. Start the Agent AI:');
    console.log('   npm run AAI:agent');
    console.log('\n4. Test the installation:');
    console.log('   npm run AAI:test-system');
    console.log('\nðŸ’¡ Available Commands:');
    Object.entries(this..cursor/rules/agentscripts).forEach(([script, command]) => {
      console.log(`   npm run ${script}`);
    });
    console.log('\nðŸ“š Documentation:');
    console.log('   .cursor/rules/agents/README.md - Agent system overview');
    console.log('   .cursor/rules/agents/_store/docs/ - Complete documentation');
    console.log('\nðŸŽ¯ The Agent AI is ready to enhance your project!');
  }

  ask(question) {
    return new Promise((resolve) => {
      this.rl.question(question, resolve);
    });
  }
}

// Run installer if called directly
if (require.main === module) {
  const installer = new AgentAIInstaller();
  installer.install().catch(console.error);
}

module.exports = AgentAIInstaller; 